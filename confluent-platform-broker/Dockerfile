FROM toastyboii/base-ol9-node:v0.0.1
EXPOSE 9092 19092
ARG CONFLUENT_USER=confluent
ARG DOCKER_HOST_IP
ARG CONFLUENT_USER_UID=1000
ARG CONFLUENT_USER_HOME=/home/$CONFLUENT_USER
ARG SCALA_VERSION=2.13
ARG KAFKA_VERSION=3.4.0
ARG CONFLUENT_PLATFORM_VERSION_MAJOR=7
ARG CONFLUENT_PLATFORM_VERSION_MINOR=4
ARG CONFLUENT_PLATFORM_VERSION_PATCH=0
ARG CONFLUENT_PLATFORM_FULL=confluent-${CONFLUENT_PLATFORM_VERSION_MAJOR}.${CONFLUENT_PLATFORM_VERSION_MINOR}.${CONFLUENT_PLATFORM_VERSION_PATCH}
ENV DOCKER_HOST_IP=$DOCKER_HOST_IP
ENV KAFKA_LOG_DIRS=/var/kafka-logs
ENV TLS_DIR="${CONFLUENT_USER_HOME}"/tls
ENV CONFLUENT_HOME="${CONFLUENT_USER_HOME}/${CONFLUENT_PLATFORM_FULL}"
ENV KAFKA_CONF_DIR="${CONFLUENT_HOME}/etc/kafka"
ENV KAFKA_REST_CONF_DIR="${CONFLUENT_HOME}/etc/kafka-rest"
ENV SCHEMA_REGISTRY_CONF_DIR="${CONFLUENT_HOME}/etc/schema-registry"
ENV SSL_KEYSTORE_PASS="${SSL_KEYSTORE_PASS:-changeit}"
ENV SSL_TRUSTSTORE_PASS="${SSL_TRUSTSTORE_PASS:-changeit}"
ENV SSL_KEY_PASS="${SSL_KEY_PASS:-changeit}"
ENV SASL_BROKER_ADMIN_USERNAME="${KAFKA_SASL_BROKER_ADMIN_USERNAME:-broker-admin}"
ENV SASL_BROKER_ADMIN_PASSWORD="${KAFKA_SASL_BROKER_ADMIN_PASSWORD:-p4ssw0rd}"
ENV PATH="${PATH}:${CONFLUENT_HOME}/bin"
COPY user.sh /tmp
RUN sh /tmp/user.sh $CONFLUENT_USER $CONFLUENT_USER_UID
USER $CONFLUENT_USER
WORKDIR $CONFLUENT_USER_HOME
COPY --chown=${CONFLUENT_USER_UID}:${CONFLUENT_USER_UID} install.sh $CONFLUENT_USER_HOME
RUN sh install.sh $CONFLUENT_PLATFORM_VERSION_MAJOR $CONFLUENT_PLATFORM_VERSION_MINOR $CONFLUENT_PLATFORM_VERSION_PATCH $CONFLUENT_PLATFORM_FULL
RUN sudo mkdir -p ${TLS_DIR} && sudo chown -R ${CONFLUENT_USER_UID}:${CONFLUENT_USER_UID} ${TLS_DIR}
RUN sudo mkdir -p ${KAFKA_LOG_DIRS} && sudo chown -R ${CONFLUENT_USER_UID}:${CONFLUENT_USER_UID} ${KAFKA_LOG_DIRS}
COPY --chown=${CONFLUENT_USER_UID}:${CONFLUENT_USER_UID} certificate-authority ${TLS_DIR}
COPY --chown=${CONFLUENT_USER_UID}:${CONFLUENT_USER_UID} kafka-configs-user-creator.sh ${CONFLUENT_USER_HOME}
COPY --chown=${CONFLUENT_USER_UID}:${CONFLUENT_USER_UID} kafka-configs-ksql-user-creator.sh ${CONFLUENT_USER_HOME}
COPY --chown=${CONFLUENT_USER_UID}:${CONFLUENT_USER_UID} ksql-acl-configurator.sh ${CONFLUENT_USER_HOME}
COPY --chown=${CONFLUENT_USER_UID}:${CONFLUENT_USER_UID} healthcheck.sh ${CONFLUENT_USER_HOME}
COPY --chown=${CONFLUENT_USER_UID}:${CONFLUENT_USER_UID} docker-entrypoint-kafka-server.sh ${CONFLUENT_USER_HOME}
COPY --chown=${CONFLUENT_USER_UID}:${CONFLUENT_USER_UID} docker-entrypoint-schema-registry.sh ${CONFLUENT_USER_HOME}
RUN chmod -x docker-entrypoint-kafka-server.sh docker-entrypoint-schema-registry.sh healthcheck.sh
RUN sudo chmod 755 ${CONFLUENT_USER_HOME}/healthcheck.sh
ENTRYPOINT ["sh", "docker-entrypoint-kafka-server.sh"]
CMD [""]
