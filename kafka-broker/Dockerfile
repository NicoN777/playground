FROM toastyboii/base-ol9-node:v0.0.1
EXPOSE 9092 19092
ARG KAFKA_USER=kafka
ARG DOCKER_HOST_IP
ARG KAFKA_USER_UID=1000
ARG KAFKA_USER_HOME=/home/$KAFKA_USER
ARG SCALA_VERSION=2.13
ARG KAFKA_VERSION=3.4.0
ENV DOCKER_HOST_IP=$DOCKER_HOST_IP
ENV KAFKA_LOG_DIRS=/var/kafka-logs
ENV TLS_DIR="${KAFKA_USER_HOME}"/tls
ENV KAFKA_HOME="${KAFKA_USER_HOME}/kafka_${SCALA_VERSION}-${KAFKA_VERSION}"
ENV KAFKA_CONF_DIR="${KAFKA_HOME}/config"
ENV SSL_KEYSTORE_PASS="${KAFKA_KEYSTORE_PASS:-changeit}"
ENV SSL_TRUSTSTORE_PASS="${KAFKA_TRUSTSTORE_PASS:-changeit}"
ENV SASL_BROKER_ADMIN_USERNAME="${KAFKA_SASL_BROKER_ADMIN_USERNAME:-broker-admin}"
ENV SASL_BROKER_ADMIN_PASSWORD="${KAFKA_SASL_BROKER_ADMIN_PASSWORD:-p4ssw0rd}"
ENV PATH="${PATH}:${KAFKA_HOME}/bin"
COPY user.sh /tmp
RUN sh /tmp/user.sh $KAFKA_USER $KAFKA_USER_UID
USER $KAFKA_USER
WORKDIR $KAFKA_USER_HOME
COPY --chown=${KAFKA_USER_UID}:${KAFKA_USER_UID} install.sh $KAFKA_USER_HOME
RUN sh install.sh $SCALA_VERSION $KAFKA_VERSION
RUN sudo mkdir -p ${TLS_DIR} && sudo chown -R ${KAFKA_USER_UID}:${KAFKA_USER_UID} ${TLS_DIR}
RUN sudo mkdir -p ${KAFKA_LOG_DIRS} && sudo chown -R ${KAFKA_USER_UID}:${KAFKA_USER_UID} ${KAFKA_LOG_DIRS}
COPY --chown=${KAFKA_USER_UID}:${KAFKA_USER_UID} certificate-authority ${TLS_DIR}
COPY --chown=${KAFKA_USER_UID}:${KAFKA_USER_UID} kafka-configs-user-creator.sh ${KAFKA_USER_HOME}
COPY --chown=${KAFKA_USER_UID}:${KAFKA_USER_UID} kafka-configs-ksql-user-creator.sh ${KAFKA_USER_HOME}
COPY --chown=${KAFKA_USER_UID}:${KAFKA_USER_UID} ksql-acl-configurator.sh ${KAFKA_USER_HOME}
COPY --chown=${KAFKA_USER_UID}:${KAFKA_USER_UID} healthcheck.sh ${CONFLUENT_USER_HOME}
COPY --chown=${KAFKA_USER_UID}:${KAFKA_USER_UID} docker-entrypoint-kafka-server.sh ${KAFKA_USER_HOME}
RUN chmod -x docker-entrypoint-kafka-server.sh
RUN sudo chmod 755 ${KAFKA_USER_HOME}/healthcheck.sh
ENTRYPOINT ["sh", "docker-entrypoint-kafka-server.sh"]
CMD [""]
